<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <link>
    <title>Exercise 4</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

<div class="file-upload">
  <div class="file-select">
    <div class="file-select-button" id="fileName">Choose File</div>
    <div class="file-select-name" id="noFile">No file chosen...</div> 
    <input type="file" name="fileUpload" id="fileUpload" accept=".txt,.json" onchange="showFileName()">
  </div>
  <div class="jsonInput">
    <textarea id="jsonInput" name="jsonInput" rows="9" cols="50" placeholder="JSON input text..." onchange="disableFile()"></textarea>
    <br><br>
  </div>
  <button id="jsonButton" onclick="uploadFile()">Upload</button>
  <button id="clearButton" onclick="clearAll()">Clear</button>
</div>

<div class="display">
  <pre id="json"></pre>
</div>

    <script>
      async function uploadFile() {
        if (fileUpload.files[0] != undefined) {
          let formData = new FormData();
          formData.append("file", fileUpload.files[0]);
          let response = await fetch("/uploadFile", {
            method: "POST",
            body: formData,
          });
          const myJson = await response.json();
          if (response.status == 200) {
            alert("File uploaded successfully.");
            document.querySelector("#json").textContent = JSON.stringify(myJson,null,2);
            document.getElementById("fileUpload").value = "";
            document.getElementById("noFile").textContent = "No file chosen...";
          }
        }else if(jsonInput.value != ""){
          const textValue = document.getElementById("jsonInput").value;
          if(isJsonString(textValue)){
            let response = await fetch("/jsonText", {
              method: "POST",
              body: textValue,
            });
            const myJson = await response.json();
          if(response.status == 200) {
            document.querySelector("#json").textContent = JSON.stringify(myJson,null,2);
          }
          }
        }else{
          alert("Please select file or insert json string before submiting.");
        }
      }

      function isJsonString(str) {
        try {
          JSON.parse(str);
        } catch (e) {
          return false;
        }
        return true;
      }

      function showFileName(){
        if(fileUpload.files[0] != undefined){
          const noFile = document.querySelector("#noFile");
          noFile.textContent = `${fileUpload.files[0].name}`;
          document.getElementById("jsonInput").disabled = true;
        }
      }

      function clearAll(){
        document.getElementById("json").textContent = "";
        document.getElementById("jsonInput").value = "";
        document.getElementById("jsonInput").disabled = false;
        document.getElementById("fileUpload").value = "";
        document.getElementById("fileUpload").disabled = false;
        document.getElementById("noFile").textContent = "No file chosen...";
      }

      function disableFile(){
        document.getElementById("fileUpload").disabled = true;
      }
    </script>
    <script
      src="https://code.jquery.com/jquery-3.6.0.js"
      integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
      crossorigin="anonymous"
    ></script>
  </body>
</html>
